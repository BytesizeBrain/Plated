# ğŸ” Mock Authentication Flow

This document explains how the mock sign-in feature works in the Plated application.

---

## ğŸ¯ Overview

The mock authentication system allows you to test the application locally without setting up Google OAuth. It uses a backend development endpoint to generate real JWT tokens for testing.

---

## ğŸ”„ Authentication Flow

### Step 1: User Clicks Mock Login

```
User clicks "Continue with Mock Login (Testing)"
      â†“
Login.tsx: handleMockLogin()
      â†“
POST http://localhost:5000/dev/login
      â†“
Backend: /dev/login endpoint generates JWT
```

**Frontend Code** (`Login.tsx`):
```typescript
const handleMockLogin = async () => {
  const response = await fetch(`${API_BASE_URL}/dev/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: 'dev@plated.local' }),
  });
  
  const data = await response.json();
  setToken(data.token);  // Save token to localStorage
  navigate('/register?token=' + data.token);
};
```

**Backend Code** (`user_routes.py`):
```python
@users_bp.route('/dev/login', methods=['POST'])
def dev_login():
    # Only works in development mode
    if env_mode == "production":
        return jsonify({"error": "dev login disabled"}), 403
    
    email = request.json.get("email", "dev@plated.local")
    
    payload = {
        "email": email,
        "display_name": "Dev User",
        "exp": int((datetime.now() + timedelta(hours=6)).timestamp())
    }
    
    token = jwt.encode(payload, app.config['JWT_SECRET'], algorithm='HS256')
    return jsonify({"token": token})
```

---

### Step 2: Redirect to Registration

```
Token received and stored in localStorage
      â†“
Navigate to /register?token=XXX
      â†“
Register.tsx: useEffect() runs
      â†“
Extract token from URL params
      â†“
Call getUserProfile() to check if user exists
```

**Frontend Code** (`Register.tsx`):
```typescript
useEffect(() => {
  const token = searchParams.get('token');
  if (!token) {
    navigate('/login');
    return;
  }
  
  setToken(token);  // Store in localStorage
  
  // Check if user already exists
  try {
    await getUserProfile();
    navigate('/profile');  // User exists, go to profile
  } catch {
    // User doesn't exist, show registration form
    const userInfo = getUserFromToken();
    setDisplayName(userInfo.display_name || '');
  }
}, [navigate]);
```

---

### Step 3A: New User - Complete Registration

```
User doesn't exist (404 error)
      â†“
Show registration form
      â†“
User enters username and display name
      â†“
POST /register with user data
      â†“
Backend creates user in database
      â†“
Navigate to /profile
```

**Frontend Code** (`Register.tsx`):
```typescript
const handleSubmit = async (e) => {
  await registerUser({
    username,
    display_name: displayName,
    profile_pic: profilePic || undefined,
  });
  
  navigate('/profile');
};
```

**Backend Code** (`user_routes.py`):
```python
@users_bp.route('/register', methods=['POST'])
@jwt_required
def complete_profile():
    email = g.jwt['email']  # From JWT token
    username = request.json['username']
    display_name = request.json['display_name']
    
    new_user = User(
        id=uuid.uuid4(),
        email=email,
        username=username,
        display_name=display_name
    )
    
    db.session.add(new_user)
    db.session.commit()
    return jsonify({"message": "User registered successfully"}), 201
```

---

### Step 3B: Existing User - Skip to Profile

```
User exists (200 response)
      â†“
Navigate directly to /profile
      â†“
Display user profile
```

---

## ğŸ”‘ JWT Token Structure

The JWT token contains:

```json
{
  "email": "dev@plated.local",
  "display_name": "Dev User",
  "exp": 1234567890
}
```

**Token Lifecycle:**
1. Generated by backend `/dev/login` endpoint
2. Stored in browser `localStorage` with key `plated_auth_token`
3. Sent with every API request in `Authorization: Bearer <token>` header
4. Validated by backend `@jwt_required` decorator
5. Expires after 6 hours

---

## ğŸ›¡ï¸ Security Features

### Development Only

The `/dev/login` endpoint is **disabled in production**:

```python
env_mode = os.getenv("ENV", "dev").lower()
flask_env = os.getenv("FLASK_ENV", "development").lower()

if env_mode == "production" or flask_env == "production":
    return jsonify({"error": "dev login disabled"}), 403
```

### Token Validation

All protected endpoints use `@jwt_required` decorator:

```python
def jwt_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_header = request.headers.get('Authorization')
        if not auth_header:
            return jsonify({"error": "Authorization header missing"}), 401
        
        token = auth_header.split(" ")[1]
        payload = jwt.decode(token, app.config['JWT_SECRET'], algorithms=['HS256'])
        g.jwt = payload
        
        return f(*args, **kwargs)
    return decorated_function
```

---

## ğŸ“¡ API Endpoints

### 1. Dev Login (POST /dev/login)

**Request:**
```json
{
  "email": "dev@plated.local"
}
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 2. Get Profile (GET /profile)

**Headers:**
```
Authorization: Bearer <token>
```

**Response (User exists):**
```json
{
  "id": "uuid",
  "email": "dev@plated.local",
  "username": "testuser",
  "display_name": "Test User",
  "profile_pic": "https://...",
  "followers_count": 0,
  "following_count": 0
}
```

**Response (User doesn't exist):**
```json
{
  "error": "User not found"
}
```
Status: 404

### 3. Register User (POST /register)

**Headers:**
```
Authorization: Bearer <token>
```

**Request:**
```json
{
  "username": "testuser",
  "display_name": "Test User",
  "profile_pic": "https://example.com/photo.jpg"
}
```

**Response:**
```json
{
  "message": "User registered successfully",
  "user_id": "uuid"
}
```

### 4. Check Username (GET /check_username?username=testuser)

**Response:**
```json
{
  "exists": false
}
```

---

## ğŸ” Debugging

### Check Token in Browser

1. Open DevTools (F12)
2. Go to Application tab
3. Local Storage â†’ http://localhost:5173
4. Look for `plated_auth_token`

### Decode JWT Token

Use [jwt.io](https://jwt.io) to decode the token and see its contents.

Or in Python:
```python
import jwt
token = "your-token-here"
decoded = jwt.decode(token, verify=False)
print(decoded)
```

Or in JavaScript console:
```javascript
const token = localStorage.getItem('plated_auth_token');
const payload = JSON.parse(atob(token.split('.')[1]));
console.log(payload);
```

### Check API Calls

1. Open DevTools (F12)
2. Go to Network tab
3. Filter by "Fetch/XHR"
4. Click on any request to see:
   - Request headers (should include `Authorization: Bearer ...`)
   - Response status and body
   - Timing information

### Common Issues

#### Token Not Being Sent

**Symptom:** API returns 401 "Authorization header is missing"

**Check:**
```javascript
// In browser console
localStorage.getItem('plated_auth_token')  // Should return a token
```

**Fix:**
```javascript
// Clear and retry
localStorage.clear();
// Then go to /login and try mock login again
```

#### Invalid Token

**Symptom:** API returns 401 "Invalid token"

**Possible Causes:**
- Token expired (6 hour expiry)
- JWT_SECRET mismatch between frontend token and backend validation
- Token corrupted

**Fix:**
```javascript
localStorage.clear();
// Get a fresh token via mock login
```

#### User Not Found After Registration

**Symptom:** Registration succeeds but profile page shows 404

**Check Database:**
```powershell
cd backend
.\venv\Scripts\Activate.ps1
python check_db.py
```

**Fix:**
```powershell
# Reset database
Remove-Item instance/users.db
python app.py
# Try registering again
```

---

## ğŸ­ Testing Scenarios

### Scenario 1: First Time User

1. Click mock login
2. Redirected to registration
3. Enter username and display name
4. Submit
5. Redirected to profile

### Scenario 2: Returning User

1. Database already has user with email `dev@plated.local`
2. Click mock login
3. Backend returns token
4. Frontend checks profile â†’ user exists
5. Redirected directly to profile (skip registration)

### Scenario 3: Token Expiry

1. User has old token (> 6 hours)
2. Try to access protected page
3. Backend returns 401
4. Frontend redirects to login
5. User needs to mock login again

### Scenario 4: Multiple Users

1. Use different emails in dev login:
```javascript
fetch('http://localhost:5000/dev/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'user1@plated.local' })
});
```

2. Each email creates a separate user account

---

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Click Mock Login
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     POST /dev/login                     â”‚
â”‚     { email: "dev@plated.local" }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Backend   â”‚
        â”‚   Flask    â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ 2. Generate JWT
              â”‚    { email, display_name, exp }
              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Return   â”‚
        â”‚   Token    â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ localStorage â”‚
       â”‚ Save Token   â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ 3. Navigate to /register
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ GET /profile    â”‚
       â”‚ (with token)    â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚
       â†“                 â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 404    â”‚      â”‚ 200       â”‚
  â”‚ Not    â”‚      â”‚ User      â”‚
  â”‚ Found  â”‚      â”‚ Exists    â”‚
  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚
      â”‚                 â†“
      â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚          â”‚ Navigate to â”‚
      â”‚          â”‚  /profile   â”‚
      â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show Register  â”‚
â”‚     Form       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 4. User submits form
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /register             â”‚
â”‚ { username, display_name } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Create   â”‚
      â”‚  User in  â”‚
      â”‚  Database â”‚
      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Navigate  â”‚
      â”‚    to     â”‚
      â”‚ /profile  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Success Indicators

When mock authentication is working correctly:

1. âœ… Mock login button redirects to registration (not reload)
2. âœ… Token appears in localStorage
3. âœ… Backend logs show `POST /dev/login` request
4. âœ… Registration form loads with no console errors
5. âœ… Username check works (availability indicator)
6. âœ… Submit redirects to profile page
7. âœ… Profile page shows user information
8. âœ… No 401 errors in network tab

---

**For more information, see:**
- `LOCAL_TESTING_QUICK_START.md` - Quick setup guide
- `START_LOCAL_TESTING.md` - Detailed testing guide
- `QUICK_START_GUIDE.md` - General application guide

